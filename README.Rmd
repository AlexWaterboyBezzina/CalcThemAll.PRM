---
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(keyring)
```

# CatchThemAll.PRM

R package for calculating **Pollutant Risk Metric** (PRM) values. The pollutant risk metric is based on the Queensland Department of Environment and Science's **Pesticide Risk Metric** and as such this package comes pre-loaded with species sensitivity distribution (SSD) data for the 22 pesticides currently used in the Queensland Department of Environment and Science *Pesticide Risk Baseline for the Reef 2050 Water Quality Improvement Plan*. The Pollutant Risk metric is an adaptable version of the pesticide risk metric that allows for the addition of new pollutants provided SSD information is available and therefore will be more widely useful.

## Installation

To install this package run this line in your R console:

```{r install, echo = T, results = "hide", message=FALSE}
devtools::install_github("https://github.com/AlexWaterboyBezzina/CatchThemAll.PRM.git")

```

## Meet the 22 Pre-loaded Pollutants

```{r echo=FALSE, warning=FALSE, message=FALSE}
library(fontawesome)
library(shiny)
p(h3("9 Photosystem II (PSII) herbicides:"),
h5(p(fa(name = "sun-plant-wilt", fill = "#28b78d", prefer_type = "solid"), "Ametryn"),
p(fa(name = "sun-plant-wilt", fill = "#28b78d", prefer_type = "solid"), "Atrazine"),
p(fa(name = "sun-plant-wilt", fill = "#28b78d", prefer_type = "solid"), "Diuron"),
p(fa(name = "sun-plant-wilt", fill = "#28b78d", prefer_type = "solid"), "Hexazinone"),
p(fa(name = "sun-plant-wilt", fill = "#28b78d", prefer_type = "solid"), "Metribuzin"),
p(fa(name = "sun-plant-wilt", fill = "#28b78d", prefer_type = "solid"), "Prometryn"),
p(fa(name = "sun-plant-wilt", fill = "#28b78d", prefer_type = "solid"), "Simazine"),
p(fa(name = "sun-plant-wilt", fill = "#28b78d", prefer_type = "solid"), "Tebuthiuron"),
p(fa(name = "sun-plant-wilt", fill = "#28b78d", prefer_type = "solid"), "Terbuthylazine")),

h3("10 Other herbicides:"),
h5(p(fa(name = "flask", fill = "#ff5964", prefer_type = "solid"), "Haloxyfop (acid)"),
p(fa(name = "flask", fill = "#ff5964", prefer_type = "solid"), "Imazapic"),
p(fa(name = "flask", fill = "#ff5964", prefer_type = "solid"), "Metsulfuron methyl"),
p(fa(name = "flask", fill = "#ff5964", prefer_type = "solid"), "Pendimethalin"),
p(fa(name = "flask", fill = "#ff5964", prefer_type = "solid"), "Metolachlor"),
p(fa(name = "flask", fill = "#ff5964", prefer_type = "solid"), "2,4-D"),
p(fa(name = "flask", fill = "#ff5964", prefer_type = "solid"), "MCPA"),
p(fa(name = "flask", fill = "#ff5964", prefer_type = "solid"), "Fluroxypyr"),
p(fa(name = "flask", fill = "#ff5964", prefer_type = "solid"), "Triclopyr"),
p(fa(name = "flask", fill = "#ff5964", prefer_type = "solid"), "Isoxaflutole metabolite (DKN)")),

h3("3 Insecticides:"),
h5(p(fa(name = "bug", fill = "#feab3a", prefer_type = "solid"), "Chlorpyrifos"),
p(fa(name = "bug", fill = "#feab3a", prefer_type = "solid"), "Fipronil"),
p(fa(name = "bug", fill = "#feab3a", prefer_type = "solid"), "Imidacloprid")))

```

## Pollutant Risk Metric (PRM)

The combined toxicity risk of these 22 pollutants and any additional added by the user is estimated by the Pollution Risk Metric. The risk is expressed as the percentage of species potentially affected (or conversely, protected) by the combined toxicity of all pollutants with provided SSD data over a standardized wet season (182 days, is the default for Queensland but this duration can be edited in the package, from the first flush event). The pollutant risk metric is based on the method for calculating pesticide risk metric values as defined by Queensland Department of Envrionment and science, which can be found [here.](https://www.publications.qld.gov.au/dataset/method-development-pesticide-risk-metric-baseline-condition-of-waterways-to-gbr/resource/c65858f9-d7ba-4aef-aa4f-e148f950220f) The key difference of the PRM is the ability to add more pollutants to the metric. The estimates can be compared to the three categories of ecosystem condition, as defined in the ![Australian and New Zealand Guidelines for Fresh & Marine Water Quality:](https://github.com/qg-qesd/WQI_CatchThemAll.PRM/blob/main/images/ANZG_table.PNG)

# How To Catch Them All (Calculate PRM)

The process for calculating PRM estimates using this method is split into **4 main parts/functions:**

1. Adding new pollutant SSD information to the metric (add_your_own_pollutant function)
2. Treating Limit of Reporting (LOR) concentration values (treat_LORs_all_data function)
3. Calculating daily average PRM estimates (calculate_daily_average_PRM)
4. Calculating wet season average PRM estimates (calculate_wet_season_average_PRM)

An example of how to run this package is provided below using the included "Kanto_pollutants" concentration data:


## Adding Your Own Pollutants

Pollutant Risk Metric values are estimated using independent action addition of pollutant risk and as such any pollutants can be added to the risk metric provided concentration measurements and SSD information is provided. This package comes pre loaded with the "pollutant_info" look up table which contains all the information for the 22 pollutants needed for the functions to estimate PRM values, and to this table new pollutants can be added. This can be done using the add_your_own_pesticides function instead of creating your own look up table seen in the example below

```{r adding_example, echo=TRUE, warning=FALSE}
library(CatchThemAll.PRM)
library(DT)
pollutant_info <- CatchThemAll.PRM::pollutant_info #the original 22 pollutants


pollutant_info <- add_your_own_pollutant(pollutants = "Poison", #adding one new pollutant
                                         relative_LORs = 0.023, pollutant_types = "Poison",
                                         distribution_types = "Log-Normal", scales = 0.09,
                                         shape_locations = 0.014)

pollutant_info <- add_your_own_pollutant(pollutants = #adding multiple new pollutants
                                           c("Poison", "Acid", "Sludge"),
                                         relative_LORs = c(0.03, 0.01, 0.5), 
                                         pollutant_types = c("Ghost", "Bug", "Poison"),
                                         distribution_types = c("Log-Normal", "Log-Logistic
                                                                Log-Logistic", "Burr Type III"),
                                         scales = c(0.3, 0.002, 2),
                                         scale_2s = c(NA, 0.04, NA), 
                                         shape_locations = c(1, 0.07, 3),
                                         shape_location_2s = c(NA, 0.14, 2.3),
                                         weights = c(NA, 0.08, NA))


```

Due to the nature of independent action addition used to calculate this metric pollutants that are not measured do not need to be removed but their cells must remain empty and for clarity the user should make it clear which pollutants have been measured and therefore make up the risk estimate.


## Treating Limit of Reporting (LOR) concentration values

How to treat Limit of Reporting values is a common issue in lab concentration measurements. This package provides two ways to treat LORs using the "treat_LORs_all_data" function. The first is the method outlined in the Pesticide Risk Metric methods document above, and the second is the replacing all LOR values with zero. An example of how to use this function can be seen below and requires a data frame of concentration values with a column that matches each pollutant name in the pollutant info look up table and a "Site Name" and "Date" column.

```{r LOR_example, echo=TRUE, warning=FALSE}
library(CatchThemAll.PRM)
head(Kanto_pollutants) #Kanto pollutant concentrations before LOR treatment

Kanto_pollutants_LOR_treated <- treat_LORs_all_data(raw_data = Kanto_pollutants,
pollutant_info = CatchThemAll.PRM::pollutant_info, treatment_method = "WQI")

head(Kanto_pollutants_LOR_treated) #Kanto pollutant concentrations after treatment

```


## Calculating daily average PRM estimates

Once LOR values have been treated daily average PRM values can be calculated using the "calculate_daily_average_PRM" function. This function is designed to run with a dataframe exported from the "treat_LORs_all_data" function. However if you skipped the treat LORs step the input data frame needs all the same columns and an additional column for sampling year. An example is shown below

```{r daily_example, echo=TRUE, warning=FALSE}
library(CatchThemAll.PRM)
Kanto_pollutants_LOR_treated <- treat_LORs_all_data(raw_data = Kanto_pollutants,
pollutant_info = CatchThemAll.PRM::pollutant_info, treatment_method = "WQI")
head(Kanto_pollutants_LOR_treated) #Kanto pollutant concentrations after treatment

#calculate daily PRM
Kanto_daily_PRM <- calculate_daily_average_PRM(LOR_treated_data = Kanto_pollutants_LOR_treated)
head(Kanto_daily_PRM)

```

This package also has a function for quickly plotting daily average PRM estimates plot_daily_PRM, for ![example:](https://github.com/AlexWaterboyBezzina/CatchThemAll.PRM/blob/main/images/plot_example.PNG)


## Calculating wet season average PRM estimates

The final part of this package is for those interested in estimating a PRM value for a reoccurring large window of time like a wet season or a period of high pollution risk. It involves using multiple imputation to predict and average PRM value of the specified window for as many window repetitions provided in the data. For example if looking at wet seasons, if 4 sampling years worth of concentration data is provided there will be a wet season estimate for each year. This is done using the "calculate_wet_season_average_PRM" function as shown below.

```{r wet_season_example, echo=TRUE, warning=FALSE}
library(CatchThemAll.PRM)
Kanto_pollutants_LOR_treated <- treat_LORs_all_data(raw_data = Kanto_pollutants,
pollutant_info = CatchThemAll.PRM::pollutant_info, treatment_method = "WQI")
Kanto_daily_PRM <- calculate_daily_average_PRM(LOR_treated_data = Kanto_pollutants_LOR_treated)


Kanto_wet_season_PSII_PRM <- calculate_wet_season_average_PRM(daily_PRM_data = Kanto_daily_PRM, PRM_group = "Total PRM") #this calculates the wet season average PRM for all pollutant groups
                         #to calculate for a specific group define it in "PRM_group ="
head(Kanto_wet_season_PSII_PRM)

```


## Disclaimer

**This package is still in development**. Information is from several sources and, as such, does not necessarily represent government or departmental policy. While every care is taken to ensure the accuracy of this information, the Department of Environment and Science makes no representations or warranties relating to  accuracy, reliability, completeness, currency or suitability for any particular purpose and disclaims all responsibility and all liability (including without limitation, liability in negligence) for all expenses, losses, damages (including indirect or consequential damage) and costs that might be incurred as a result of any use or of reliance on the information and calculated data in any way and for any reason.

## Citation

**R Package:**

*Bezzina A, Neelamraju C, Strauss J, Kaminski H, Roberts C, Glen J, Dias F. 2022. CatchThemAll.PRM: Pesticide Risk Metric Calculations. R package. Water Quality Monitoring & Investigations, Department of Environment and Science, Queensland Government. https://github.com/AlexWaterboyBezzina/CatchThemAll.PRM*

**Methods Behind Pesticide Risk Metric:**

*Warne MStJ, Neelamraju C, Strauss J, Smith RA, Turner RDR, Mann RM. 2020. Development of a method for estimating the toxicity of pesticide mixtures and a Pesticide Risk Baseline for the Reef 2050 Water Quality Improvement Plan. Brisbane: Department of Environment and Science, Queensland Government.*
